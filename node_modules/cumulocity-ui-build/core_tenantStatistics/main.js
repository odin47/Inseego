/* core_tenantStatistics 9.12.5 2018-08-27T16:54:44+00:00 b689bea882f7+ (release/9.12.0) tip */
!function(){"use strict";function t(t,e,n){t.addNavigation({parent:n("Tenants"),name:n("Usage statistics"),path:"tenantStatistics",icon:"c8y-usage-statistics",showIf:["c8yUserUtil",function(t){return t.showTenantManagement()}]}),e.when("/tenantStatistics",{template:"<c8y-tenant-statistics />"})}t.$inject=["c8yNavigatorProvider","c8yViewsProvider","gettext"],angular.module("c8y.tenantStatistics",[]).config(t)}();var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t};!function(){"use strict";function t(t,e,n,i,r,o,a,s,u,c,l,m,g,p,d){function f(){var t=_.get(w.statistics,"length"),e=d.getPlural(t,"1 tenant","{{$count}} tenants",{});return _.isNumber(t)?e:""}function C(){w.refreshLoading=!0,v().then(h).then(y).then(P).then(D).then(B).then(F).then(function(){w.refreshLoading=!1})}function v(){return s.isCurrentUserTopTenant().then(function(t){w.isTopTenant=t})}function h(){w.storageLimitFeatureEnabled=o.appOption("storageLimitationFeatureEnabled")}function y(){w.dateFrom=c.stringToDate(n.dateFrom)||N,w.dateTo=c.stringToDate(n.dateTo)}function P(){return a.list(S()).then(b)}function S(){return{dateFrom:c.dateToString(w.dateFrom),dateTo:c.dateToString(w.dateTo)}}function b(t){w.statistics=T(t)}function T(t){return _.map(t,function(t){return _extends({},t,{storageQuota:k(x(t)),storageSize:k(t.storageSize),peakStorageSize:k(t.peakStorageSize)})})}function k(t){return!_.isUndefined(t)&&Number((t/Math.pow(2,20)).toFixed(2))}function x(t){var e=t.storageLimitPerDevice,n=t.deviceWithChildrenCount,i=e;return i&&(i*=n||1),i}function D(){var t="c8ySchema!!customProperties";return L.list().then(function(e){return _.filter(e,{id:t})}).then(function(t){return L.getSchema(t)}).then(function(t){return _.get(t,"properties.customProperties.properties",{})}).then(function(t){return _.map(t,function(t,e){return{title:t.title,key:e,schema:t}})}).then(function(t){w.customProperties=_.sortBy(t,"title")})}function B(){w.columns=M(),w.columnsConfig={}}function M(){return _([m.getTenantIdColumn(),m.getTenantNameUrlColumn(),q(),m.getApiRequestsColumn(),m.getDeviceApiRequestsColumn(),w.storageLimitFeatureEnabled?m.getStorageQuotaColumn():null,m.getStorageSizeColumn(),m.getPeakStorageSizeColumn(),m.getRootDevicesColumn(),m.getPeakRootDevicesColumn(),m.getDevicesColumn(),m.getPeakDevicesColumn(),m.getDeviceEndpointCountColumn(),m.getSubscribedApplicationsColumn(),m.getCreationTimeColumn(),w.isTopTenant?m.getParentTenantIdColumn():null]).flattenDeep().compact().orderBy([function(t){return t.priority||0}],["desc"]).value()}function q(){return _.map(w.customProperties,function(t){return m.getCustomPropertyColumn(t)})}function I(t){F(t)}function F(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:w.columnsConfig;w.columnsConfig=t,w.filteredSortedStatistics=g.filterSort(w.statistics,w.columns,w.columnsConfig)}function V(){return _(w.columns).map(function(t){return _.result(t,"getCsvHeaders")||_.get(t,"header.text")||_.get(t,"header")}).flatten().value()}function R(){return _.map(w.filteredSortedStatistics,function(t){return _(w.columns).map(function(e){return e.getCsvValues(t)}).flatten().value()})}function z(t){i.path("/tenants/"+t.tenantId)}function E(){_.isEqual(S().dateFrom,N)&&_.isUndefined(S().dateTo)||i.search(S())}function A(){i.search({})}function U(){C()}var w=this,L=l.another(l.paths.Tenants),N=c.stringToDate(o.fromThisMonthStartFilter().dateFrom),W=p("No tenants to display.");_.assign(w,{noItemsMessage:W,getSubtitle:f,$onInit:C,onColumnsConfigChanged:I,getCsvHeaders:V,getCsvData:R,detail:z,filter:E,clearFilter:A,refresh:U})}t.$inject=["$scope","$q","$routeParams","$location","$filter","c8yBase","c8yStatistics","c8yTenant","c8yTitle","c8yUtil","c8yPropertiesLibrary","c8yTenantStatisticsColumns","c8yFilteringSortingCollections","gettext","gettextCatalog"],angular.module("c8y.tenantStatistics").component("c8yTenantStatistics",{templateUrl:"core_tenantStatistics/tenant-statistics.html",controller:t,controllerAs:"vm"})}(),function(){"use strict";function t(t,e,n){function i(){return t.getColumn({name:"tenantId",header:n("Id"),cell:{template:"{{item.tenantId}}"},filteringByPattern:{itemProperty:"tenantId"},sortingByPath:{itemProperty:"tenantId"},getCsvValues:function(t){return[t.tenantId]}})}function r(){var e=function(t){return"https://"+t.tenantDomain};return t.getColumn({name:"tenantNameUrl",header:n("Name"),cell:{template:'<a ng-href="{{getTenantUrl(item)}}">{{item.tenantCompany}}</a>',scopeExtensions:{getTenantUrl:e}},filteringByPattern:{itemProperty:"tenantCompany"},sortingByPath:{itemProperty:"tenantCompany"},getCsvHeaders:function(){return[n("Name"),n("URL")]},getCsvValues:function(t){return[t.tenantCompany,e(t)]}})}function o(e){var n=e.key,i=["tenantCustomProperties",n],r={name:n,priority:_.startsWith(n,"limit.")?-1e3:0,header:e.title,cell:{template:"<div\n            ng-bind-html=\"getValue(item, '"+n+"') |\n              formatBySchema:getSchema(tenantCustomProperties, '"+n+"')\">\n          </div>",scopeExtensions:{getValue:function(t,e){return _.get(t,["tenantCustomProperties",e])},getSchema:function(t,e){return _.get(t,[e,"schema"])}}},getCsvHeaders:function(){return["externalReference"===n?e.title:n]},getCsvValues:function(t){return[s(t,e)]}};return _.merge(r,a(e)),_.set(r.cell.scopeExtensions,i,e),t.getColumn(r)}function a(t){var n=e.getType(t),i=n.filteringKey,r="sortingByPath",o=["tenantCustomProperties",t.key],a={itemProperty:o},s={};return _.set(s,i,a),_.set(s,r,a),s}function s(t,e){var n=_.get(e,"schema.default");return _.get(t,["tenantCustomProperties",e.key],n)}function u(){return t.getColumn({name:"requestCount",header:n("API requests"),cell:{template:"{{item.requestCount}}"},filteringByMinMax:{itemProperty:"requestCount"},sortingByPath:{itemProperty:"requestCount"},getCsvValues:function(t){return[t.requestCount]}})}function c(){return t.getColumn({name:"deviceRequestCount",header:n("Device API requests"),cell:{template:"{{item.deviceRequestCount}}"},filteringByMinMax:{itemProperty:"deviceRequestCount"},sortingByPath:{itemProperty:"deviceRequestCount"},getCsvValues:function(t){return[t.deviceRequestCount]}})}function l(){return t.getColumn({name:"storageQuota",header:n("Storage quota (MB)"),cell:{template:'<span ng-if="item.storageLimitPerDevice">{{item.storageQuota}}</span>'},filteringByMinMax:{itemProperty:"storageQuota"},sortingByPath:{itemProperty:"storageQuota"},getCsvValues:function(t){return[t.storageQuota||""]}})}function m(){return t.getColumn({name:"storageSize",header:n("Storage (MB)"),cell:{template:"{{item.storageSize}}"},filteringByMinMax:{itemProperty:"storageSize"},getCsvValues:function(t){return[t.storageSize]}})}function g(){return t.getColumn({name:"peakStorageSize",header:n("Peak storage (MB)"),cell:{template:"{{item.peakStorageSize}}"},filteringByMinMax:{itemProperty:"peakStorageSize"},getCsvValues:function(t){return[t.peakStorageSize]}})}function p(){return t.getColumn({name:"deviceCount",header:{text:n("Root devices"),tooltip:{icon:"question-circle-o",text:n("Number of root devices, excluding child devices")}},cell:{template:"{{item.deviceCount}}"},filteringByMinMax:{itemProperty:"deviceCount"},sortingByPath:{itemProperty:"deviceCount"},getCsvValues:function(t){return[t.deviceCount]}})}function d(){return t.getColumn({name:"peakDeviceCount",header:{text:n("Peak root devices"),tooltip:{icon:"question-circle-o",text:n("Peak number of root devices, excluding child devices")}},cell:{template:"{{item.peakDeviceCount}}"},filteringByMinMax:{itemProperty:"peakDeviceCount"},sortingByPath:{itemProperty:"peakDeviceCount"},getCsvValues:function(t){return[t.peakDeviceCount]}})}function f(){return t.getColumn({name:"deviceWithChildrenCount",header:{text:n("Devices"),tooltip:{icon:"question-circle-o",text:n("Number of devices, including child devices")}},cell:{template:"{{item.deviceWithChildrenCount}}"},filteringByMinMax:{itemProperty:"deviceWithChildrenCount"},sortingByPath:{itemProperty:"deviceWithChildrenCount"},getCsvValues:function(t){return[t.deviceWithChildrenCount]}})}function C(){return t.getColumn({name:"peakDeviceWithChildrenCount",header:{text:n("Peak devices"),tooltip:{icon:"question-circle-o",text:n("Peak number of devices, including child devices")}},cell:{template:"{{item.peakDeviceWithChildrenCount}}"},filteringByMinMax:{itemProperty:"peakDeviceWithChildrenCount"},sortingByPath:{itemProperty:"peakDeviceWithChildrenCount"},getCsvValues:function(t){return[t.peakDeviceWithChildrenCount]}})}function v(){return t.getColumn({name:"subscribedApplications",header:n("Subscribed applications"),cell:{template:"{{(item.subscribedApplications || []).length}}"},filteringByMinMax:{itemProperty:"subscribedApplications.length"},sortingByPath:{itemProperty:"subscribedApplications.length"},getCsvValues:function(t){return[_.join(t.subscribedApplications," ")]}})}function h(){return t.getColumn({name:"creationTime",header:n("Creation time"),cell:{template:"{{item.creationTime | absoluteDate}}"},filteringByMinMaxDate:{itemProperty:"creationTime"},sortingByPath:{itemProperty:"creationTime"},getCsvValues:function(t){return[t.creationTime&&moment(t.creationTime).format("L")]}})}function y(){return t.getColumn({name:"parentTenantId",header:n("Parent tenant"),cell:{template:"{{item.parentTenantId}}"},filteringByPattern:{itemProperty:"parentTenantId"},sortingByPath:{itemProperty:"parentTenantId"},getCsvValues:function(t){return[t.parentTenantId]}})}function P(){return t.getColumn({name:"deviceEndpointCount",header:{text:n("Endpoint devices"),tooltip:{icon:"question-circle-o",text:n("Leaf machines (without gateways and edges)")}},cell:{template:"{{item.deviceEndpointCount}}"},filteringByPattern:{itemProperty:"deviceEndpointCount"},sortingByPath:{itemProperty:"deviceEndpointCount"},getCsvValues:function(t){return[t.deviceEndpointCount]}})}return{getTenantIdColumn:i,getTenantNameUrlColumn:r,getCustomPropertyColumn:o,getApiRequestsColumn:u,getDeviceApiRequestsColumn:c,getStorageQuotaColumn:l,getStorageSizeColumn:m,getPeakStorageSizeColumn:g,getRootDevicesColumn:p,getPeakRootDevicesColumn:d,getDevicesColumn:f,getPeakDevicesColumn:C,getSubscribedApplicationsColumn:v,getCreationTimeColumn:h,getParentTenantIdColumn:y,getDeviceEndpointCountColumn:P}}t.$inject=["c8yFilteringSortingCollections","SchemaPropertiesSvc","gettext"],angular.module("c8y.tenantStatistics").factory("c8yTenantStatisticsColumns",t)}(),function(){"use strict";function t(t){var e;e='<c8y-ui-title-set title="\'Usage statistics\' | translate" subtitle="vm.getSubtitle()">\r\n</c8y-ui-title-set>\r\n\r\n<c8y-ui-action-bar-set>\r\n  <li class="navbar-form" action-bar-position="left">\r\n    <form class="form-inline">\r\n      <div class="form-group datepicker">\r\n        <input class="form-control" style="width: 120px; text-align: center" ng-model="vm.dateFrom" uib-datepicker-popup datepicker-options="{maxDate: vm.dateTo}" is-open="openFrom" ng-click="openFrom=true" placeholder="{{\'Date from\' | translate}}">\r\n      </div>\r\n      <div class="form-group datepicker">\r\n        <input class="form-control" style="width: 120px; text-align: center" ng-model="vm.dateTo" uib-datepicker-popup datepicker-options="{minDate: vm.dateFrom}" is-open="openTo" ng-click="openTo=true" placeholder="{{\'Date to\' | translate}}">\r\n      </div>\r\n      <button name="apply" type="submit" class="btn btn-link" style="display: inline-block; width: auto" ng-click="vm.filter()" title="{{\'Apply filters\' | translate}}">\r\n        <i c8y-icon="filter"></i>\r\n        {{\'Filter\' | translate}}\r\n      </button>\r\n      <button ng-if="vm.dateFrom || vm.dateTo" name="clear" type="button" class="btn btn-link" style="display: inline-block; width: auto" ng-click="vm.clearFilter()" title="{{\'Clear filters\' | translate}}">\r\n        <i c8y-icon="times"></i>\r\n      </button>\r\n    </form>\r\n  </li>\r\n\r\n  <a href="" class="btn btn-link" c8y-csv-exporter c8y-headers="vm.getCsvHeaders()" c8y-data="vm.getCsvData()">\r\n  <i c8y-icon="table"></i>\r\n    {{\'Export CSV\' | translate}}\r\n  </a>\r\n\r\n  <button type="button" class="btn btn-link" ng-click="vm.refresh()">\r\n    <i c8y-icon="refresh" ng-class="{\'fa-spin\': vm.refreshLoading}"></i>\r\n    {{\'Reload\' | translate}}\r\n  </button>\r\n</c8y-ui-action-bar-set>\r\n\r\n<div>\r\n  <c8y-filtered-sorted-list columns="vm.columns" columns-config="vm.columnsConfig" on-columns-config-changed="vm.onColumnsConfigChanged(columnsConfig)" items="vm.filteredSortedStatistics" no-items-message="vm.noItemsMessage" on-item-click="vm.detail(item)">\r\n  </c8y-filtered-sorted-list>\r\n</div>\r\n',t.put("tenantStatistics/tenant-statistics.html",e),t.put("core_tenantStatistics/tenant-statistics.html",e),t.put("/apps/core/tenantStatistics/tenant-statistics.html",e)}angular.module("c8y.tenantStatistics").run(["$templateCache",t])}();