/* devicemanagement_location 9.12.5 2018-08-27T16:54:02+00:00 b689bea882f7+ (release/9.12.0) tip */
!function(){"use strict";function n(n,t,e){var a={lat:51.2433101,lng:6.7303924};n.when("/device/:deviceId",{name:e("Location"),templateUrl:"devicemanagement_location/views/index.html",icon:"location-arrow",showIf:["$routeParams","$location","c8yDevices","c8yActions",function(n,t,o,i){var l=n.deviceId,c="/device/"+l+"/location",s=o.detailCached(l).then(function(n){var t=n.data,e="c8y_Position",a="com_nsn_startups_vendme_fragments_GPSCoordinates",o=t[e]||t[a];return o});return s.then(function(n){n||i.addAction({text:e("Add location"),priority:1e3,showIfPermissions:{adminMOs:[l]},action:function(){o.save({id:l,c8y_Position:_.cloneDeep(a)}).then(function(){t.path(c)})}})}),s}]}),t.add({name:e("Location"),description:e("Displays a map with device position marker"),templateUrl:"devicemanagement_location/views/component.html",options:{noNewWidgets:!0}})}n.$inject=["c8yViewsProvider","c8yComponentsProvider","gettext"],angular.module("c8y.parts.location",[]).config(n)}(),angular.module("c8y.parts.location").controller("locationCtrl",["$scope","$routeParams","c8yBase","c8yGeo","c8yDevices","c8yRealtime","c8yAlert","gettext",function(n,t,e,a,o,i,l,c){"use strict";function s(t){L=t;var e=n.location=y(t)||{};r(n.location),I=_.clone(e),m(e)&&g(e)}function r(n){_.set(n,"lat",_.toNumber(_.get(n,"lat"))),_.set(n,"lng",_.toNumber(_.get(n,"lng")))}function d(n,t){f(t.model)}function u(n){if(n){var t={lat:Number(n.lat),lng:Number(n.lon),zoom:17};g(t),f(t),w(t)}}function m(n){return!(!n.lat||!n.lng)}function p(){return n.child&&n.child.config&&n.child.config.device&&(R.draggable=!1),n.child&&n.child.config&&n.child.config.device&&n.child.config.device.id||t.deviceId}function v(){o.detailCached(p()).then(function(n){return _.cloneDeep(n.data)}).then(s)}function g(n){_.assign(R,{lat:parseFloat(n.lat),lng:parseFloat(n.lng)}),G.main=R,w(R)}function b(n){return n%=360,n<-180?n+360:n>180?n-360:n}function f(t){_.assign(n.location,{lat:parseFloat(t.lat),lng:b(parseFloat(t.lng))})}function h(n){return o.isVendme(n)?N:E}function y(n){return n[h(n)]}function w(t){var e=t||R;n.center=n.center,_.assign(n.center,e)}function k(n){a.geoCode(n).then(function(n){return 0===n.data.length&&l.warning(c("Address could not be found!")),n.data[0]||null}).then(u)}function x(){n.noeditable=!n.noeditable,_.isEqual(n.location,I)||(n.location=_.clone(I))}function C(){n.noeditable=!n.noeditable;var t={id:L.id},e=_.clone(y(L));delete e.address,t[h(L)]=e,$(t[h(L)]),o.save(t).then(function(){l.success(c("Location successfully saved!"))}).then(v)}function $(n){_.set(n,"lat",_.get(n,"lat").toString()),_.set(n,"lng",_.get(n,"lng").toString())}function D(n,t){s(t)}function A(n,t){s(t)}function F(){v()}function P(){z?n.switchRealtime():v()}var L,I,E="c8y_Position",N="com_nsn_startups_vendme_fragments_GPSCoordinates",S={latitude:/^[-+]?([1-8]?\d(\.\d+)?|90(\.0+)?)$/,longitude:/^[-+]?(180(\.0+)?|((1[0-7]\d)|([1-9]?\d))(\.\d+)?)$/,altitude:/^[-+]?(0|([1-9]\d*))(\.\d+)?$/},z=!1,M=11,q={},G={},R={focus:!0,draggable:!0},U={scrollWheelZoom:!1},j={lat:0,lng:0,zoom:M},T={markers:["dragend"]};n.settings=q,n.markers=G,n.mapDefaults=U,n.centerMap=w,n.center=j,n.pattern=S,n.$on("leafletDirectiveMarker.dragend",d),n.events=T,n.gotoAddress=k,n.cancel=x,n.save=C,n.realtimeChannel="/managedobjects/"+(void 0!==t.deviceId?t.deviceId:"*"),n.invalid=angular.bind(e,e.invalid,n),n.$watch("child.config.device",v),i.addListener(n.$id,n.realtimeChannel,n.$id+"-subscribed",F),i.addListener(n.$id,n.realtimeChannel,"CREATE",D),i.addListener(n.$id,n.realtimeChannel,"UPDATE",A),P()}]),function(){"use strict";function n(n){var t;t='<div data-ng-controller="locationCtrl">\n<leaflet width="100%" height="250px" markers="markers" center="center" defaults="mapDefaults" event-broadcast="events"></leaflet>\n</div>',n.put("location/views/component.html",t),n.put("devicemanagement_location/views/component.html",t),n.put("/apps/devicemanagement/location/views/component.html",t),t='<div data-ng-controller="locationCtrl">\n\n  <c8y-ui-action-bar-set>\n    <c8y-realtime-btn class="btn btn-link" style="margin-left: -12px"></c8y-realtime-btn>\n\n    <button class="btn btn-link" title="{{\'Center map\' | translate}}" ng-click="centerMap()">\n        <i c8y-icon="dot-circle-o"></i> {{\'Center map\' | translate}}\n      </button>\n  </c8y-ui-action-bar-set>\n\n  <div class="row">\n    <div class="col-md-8">\n      <leaflet width="100%" height="600px" style="margin-bottom:15px" markers="markers" center="center" defaults="mapDefaults" event-broadcast="events"></leaflet>\n    </div>\n\n    <div class="col-md-4">\n      <div class="card">\n        <div class="card-header">\n          <span class="h4 card-title" translate>Current location</span>\n          <div class="flex-item-right" ng-show="!noeditable">\n            <small>\n              <a href="" class="text-gray" ng-click="noeditable = !noeditable" translate>\n                Edit location\n              </a>\n            </small>\n            <a tabindex="0" uib-popover-html="\'Device location may be set by the device itself, or manually in the platform\' | translate" popover-append-to-body="true" popover-placement="left" popover-trigger="\'focus\'" style="display:inline-block">\n              <i c8y-icon="question-circle-o"></i>\n            </a>\n          </div>\n        </div>\n        <hr>\n        <div class="card-block" ng-class="{\'form-read-only\': !noeditable}">\n          <form name="locationForm" novalidate class="form-horizontal">\n            <div class="form-group" ng-class="{\'has-error\': invalid(\'locationForm\', \'latitude\')}">\n              <label class="col-sm-4 control-label"><span translate>Latitude</span> (°)</label>\n              <div class="col-sm-8">\n                <input type="number" name="latitude" class="form-control" ng-model="location.lat" ng-pattern="pattern.latitude">\n              </div>\n            </div>\n\n            <div class="form-group" ng-class="{\'has-error\': invalid(\'locationForm\', \'longitude\')}">\n              <label class="col-sm-4 control-label"><span translate>Longitude</span> (°)</label>\n              <div class="col-sm-8">\n                <input type="number" name="longitude" class="form-control" ng-model="location.lng" ng-pattern="pattern.longitude">\n              </div>\n            </div>\n\n            <div class="form-group" ng-class="{\'has-error\': invalid(\'locationForm\', \'altitude\')}">\n              <label class="col-sm-4 control-label"><span translate>Altitude</span> <span class="text-lowercase">(m)</span></label>\n              <div class="col-sm-8">\n                <input type="number" name="altitude" class="form-control" ng-model="location.alt" ng-pattern="pattern.altitude">\n              </div>\n            </div>\n          </form>\n        </div>\n\n        <hr ng-show="noeditable" style="margin-bottom: 20px">\n\n        <div class="form-horizontal" style="padding: 0 20px">\n          <div class="form-group">\n            <form name="addressForm" ng-show="noeditable" novalidate ng-submit="gotoAddress(location.address)">\n              <label class="control-label col-md-4" translate>Address</label>\n              <div class="col-md-8">\n                <div class="input-group input-group-search">\n                  <input type="text" ng-model="location.address" placeholder="{{\'Find lat/long by address\' | translate}}" class="form-control">\n                  <span class="input-group-btn">\n                    <button class="btn btn-link" type="submit">\n                      <i c8y-icon="search"></i>\n                    </button>\n                  </span>\n                </div>\n              </div>\n            </form>\n          </div>\n        </div>\n\n        <hr>\n\n        <div class="card-footer" ng-show="noeditable">\n          <button class="btn btn-default" ng-click="cancel()" translate>Cancel</button>\n          <button class="btn btn-primary" ng-disabled="locationForm.$invalid" ng-click="save()" translate>Save</button>\n\n          <!-- <div ng-show="!noeditable">\n            <button class="btn btn-default" ng-click="noeditable = !noeditable"><i c8y-icon="pencil"></i> Edit location</button>\n            <span class="">\n              <a tabindex="0" uib-popover-html="\'Device location may be set by the device itself, or manually in the platform\' | translate" popover-append-to-body="true" popover-placement="left" popover-trigger="\'focus\'" style="display:inline-block;">\n                <i c8y-icon="question-circle-o"></i>\n              </a>\n            </span>\n          </div> -->\n        </div>\n      </div>\n\n    </div>\n  </div>\n\n</div>',n.put("location/views/index.html",t),n.put("devicemanagement_location/views/index.html",t),n.put("/apps/devicemanagement/location/views/index.html",t)}angular.module("c8y.parts.location").run(["$templateCache",n])}();